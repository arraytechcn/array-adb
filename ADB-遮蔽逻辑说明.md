# ADB 智能遮蔽逻辑

## 概述

ADB（Adaptive Driving Beam）系统通过实时检测前方车辆，动态控制 LED 矩阵大灯的遮蔽区域，避免对其他驾驶员造成眩光。

## 遮蔽逻辑

### 1. 目标检测

- 摄像头实时检测前方车辆（车头灯/尾灯）
- 以画面中心为界，分为左侧目标和右侧目标
- 左侧目标控制左灯遮蔽，右侧目标控制右灯遮蔽

### 2. 遮蔽开始

**核心原则：只遮挡目标实际所在的位置**

```
目标出现在右侧第10列位置
    ↓
只遮蔽第10列附近区域
    ↓
不会从中心开始整排遮蔽
```

- 检测到目标后，计算目标的左边界 `min_x` 和右边界 `max_x`
- 将像素坐标映射到 LED 列号
- 遮蔽范围 = 目标左边界列 → 目标右边界列

### 3. 平滑扩展

遮蔽区域不会瞬间跳变，而是平滑过渡：

```python
# 平滑速度 (0.15 = 每帧移动15%的差距)
new_min_x = old_min_x + (target_min_x - old_min_x) * 0.15
new_max_x = old_max_x + (target_max_x - old_max_x) * 0.15
```

- 目标移动时，遮蔽区域跟随移动
- 目标变大时，遮蔽区域平滑扩展
- 目标变小时，遮蔽区域平滑收缩

### 4. 遮蔽恢复

**核心原则：从遮蔽位置开始恢复，不是从中心恢复**

```
目标消失
    ↓
记录最后遮蔽范围 (start_col, end_col)
    ↓
从 end_col 向 start_col 逐列恢复
    ↓
恢复完成后清除状态
```

恢复动画：
- 恢复速度：每帧 1 列
- 恢复方向：从外向内（从遮蔽边缘向目标消失位置推进）
- 视觉效果：紫色指示条显示恢复进度

## 网格显示

LED 网格位于画面底部（FPS 文字附近），高度为画面的 12.5%：

```
┌─────────────────────────────────┐
│                                 │
│         摄像头画面               │
│                                 │
│                                 │
├────────────────┬────────────────┤
│   左灯网格      │    右灯网格     │  ← 12.5% 高度
└────────────────┴────────────────┘
```

网格颜色：
- 绿色：正常照明
- 蓝色：遮蔽区域
- 深蓝色：顶行遮蔽
- 紫色：恢复进度指示

## 通信协议

MaixCAM → array_now → headlight

```
数据格式: prefix(17字节) + 'S' + count(1字节) + LED_IDs(count字节)
发送间隔: 100ms 队列执行
执行条件: 近光灯状态下执行 ADB
```
